package net.foxycorndog.arrowide.printer;

import java.awt.Color;

import org.eclipse.swt.custom.StyleRange;
import org.eclipse.swt.graphics.Font;
import org.eclipse.swt.graphics.GC;
import org.eclipse.swt.graphics.Point;
import org.eclipse.swt.graphics.Rectangle;
import org.eclipse.swt.printing.Printer;
import org.eclipse.swt.printing.PrinterData;

public class TextPrinter
{
	private Rectangle	bounds;

	private String		text;
	
	private Font		font;

	private Printer		printer;
	
	private StyleRange	styles[];
	
	public TextPrinter(PrinterData data, String text, Font font, StyleRange styles[])
	{
		this.text = text;
		
		this.font = font;
		
		printer = new Printer(data);
		
		bounds  = new Rectangle(0, 0, 0, 0);
	}
	
	public boolean print()
	{
		int x = bounds.x;
		int y = bounds.y;
		
		boolean printed = false;
		
		if (printer.startJob("ArrowIDE Printer"))
		{
			GC gc = new GC(printer);
			Font printerFont = new Font(printer, font.getFontData());
			gc.setFont(printerFont);
			int lineHeight = gc.getFontMetrics().getHeight();
			
			if (printer.startPage())
			{
				for (int i = 0; i < text.length(); i ++)
				{
					if (y > bounds.height + bounds.y)
					{
						printer.endPage();
						printer.startPage();
						
						y = bounds.y;
					}
					
					y += lineHeight;
				}
				
				printer.endPage();
			}
			
			gc.dispose();
			printer.endJob();
			
			printed = true;
		}
		
		printer.dispose();
		
		return printed;
	}
	
	private void print(String word, int x, int y, GC gc, int offset)
	{
		for (int i = 0; i < word.length(); i ++)
		{
			print(word.charAt(i), x, y, gc, offset);
		}
	}
	
	private void print(char c, int x, int y, GC gc, int offset)
	{
		gc.setForeground(Color.BLUE);
		
		gc.drawText(c + "", x, y);
	}
	
	public void setMargins(float left, float top, float right, float bottom)
	{
		Rectangle rect = printer.getClientArea();
		Rectangle trim = printer.computeTrim(0, 0, 0, 0);
		Point dpi = printer.getDPI();
		
		int left2 = trim.x + (int)(dpi.x * left);
		if (left2 < rect.x)
		{
			left2 = rect.x;
		}
		
		int right2 = rect.width + trim.x + trim.width - (int)(dpi.x * right);
		if (right2 > rect.width)
		{
			right2 = rect.width;
		}
		
		int top2 = trim.y + (int)(dpi.y * top);
		if (top2 < rect.y)
		{
			top2 = rect.y;
		}
		
		int bottom2 = rect.height + trim.y + trim.height - (int)(dpi.y * bottom);
		if (bottom2 > rect.height)
		{
			bottom2 = rect.height;
		}
		
		bounds = new Rectangle(left2, top2, right2 - left2, bottom2 - top2);
	}
}